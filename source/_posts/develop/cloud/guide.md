---
title: 开发指南
header: develop
nav: guide
sidebar: guide
---

## 环境

环境是云开发各类资源的承载集合。环境与环境之间是完全隔离的，也就是说，不同环境下，所有云上托管资源（数据库、存储、函数等）均不互通。使用云开发服务必须至少创建一个环境，每个环境均有一个唯一的环境 ID，可以在云开发控制台的概览页面找到。

一个智能小程序最多可以创建 2 个环境，建议的实践为创建一个开发测试环境和一个线上生产环境。利用环境间数据隔离的特性，在日常开发时使用开发测试环境，正式发布的版本使用线上生产环境，这样可以在开发调试智能小程序的同时保证生产环境数据的稳定性。

初始化云开发 SDK 时，可以指定使用哪个环境，参见 [swan.cloud.init](/develop/cloud/cloud_init)。在云函数中初始化 SDK 时，如果没有指定环境 ID，则会默认使用该函数当前所处的环境。

## 云函数开发指南

### 云函数使用常见问题

#### 云函数使用什么语言开发和运行？
目前提供 Node.js 8.5 的运行时环境。

#### 同一个函数的数次调用之间能否共享数据？
使用云函数的最佳实践之一是尽量保持云函数的无状态性。也就是说，每次调用需要保证相互独立，重复执行结果应当保持一致。云函数的调度引擎会根据调用的频率自动伸缩计算资源，对于同一个云函数，在同一时间点可能有多个实例正在工作，当函数结果返回后，这些实例可能仍会存活一段时间，以供潜在的新一次调用。因此，在一定程度内，两次调用之间是有可能共享数据的（例如在临时目录内写入的数据）。但是开发者不应当依赖这一点，因为调度引擎的行为是不可预知的，两次调用不一定会使用同一个计算资源，而且计算资源会随时被销毁重建。总体而言，开发者需要遵循云函数的无状态性原则。

#### 函数运行资源有什么限制？
* 临时磁盘空间：用户函数只可读写 /tmp 这个临时目录
* 函数申请内存区间：参见配额限制
* 函数最大运行时间：参见配额限制
* 代码部署包大小(压缩为.zip文件)：50M
* 原始代码大小：250 MB
* 函数同步调用请求正文负载大小：6 MB

#### 如何编写有异步过程的云函数？
将入口函数标记为 `async` 即可，Node.js 8.5 的运行时环境支持 async/await 关键词。
```js
exports.main = async (event, context) => {
    const someAsyncData = await getAsyncData()
    return someAsyncData
}
```

#### 如何在函数中引用外部依赖包？
与一般的 Node.js 程序无异，编写 `package.json`文件，使用 npm 等工具将外部依赖安装至 `node_modules` 目录中，然后将这些文件一起打包上传部署即可。

#### 是否需要将 `node_modules` 一起上传部署？
需要。

#### 在云函数中访问云数据库和云存储，是否自带权限控制？
没有，可以任意读写数据。

#### 应该使用 swan-server-sdk 的什么版本？
随着云开发的功能迭代，SDK 也不会不断更新，建议使用保持使用最新版本。SDK 更新时会尽量兼容旧版，当必须做出不兼容变更时，会使用大版本号更新。

### 云函数使用示例：在智能小程序中调用云函数

在本例中，我们会创建一个名为 sum 的函数，他可以接收一系列数字作为输入，并且将他们的和返回。

我们先创建一个 sum 函数，并且修改其中的 index.js 文件。本例中无需使用云开发SDK，因此没有做初始化等工作。

```js
	exports.main = (event, context) => {
	    if (Array.isArray(event['numbers'])) {
	        let sum = 0;
	        for (let i = 0; i < event['numbers'].length; i++) {
	            let n = parseInt(event['numbers'][i], 10);
	            sum += n;
	        }
	        return sum
	    } else {
	        throw new Error('no numbers');
	    }
	};
```

这个函数在 `event` 中接收一个 `numbers` 数组，并且将它们的和返回。

上传部署函数后，我们可以在云开发控制台中测试这个函数，可以使用以下内容作为测试输入：

```json
{
    "numbers": [1, 2, 3, 4]
}
```

可以看到该云函数能够正确返回结果。

在智能小程序中，通过以下方式调用这个云函数获取结果：

```js
swan.cloud.callFunction({
    // 云函数名称
    name: 'sum',
    // 传给云函数的参数
    data: {
        numbers: [1, 2, 3, 4]
    },
    success: function(res) {
        console.log(res.result)
    },
    fail: console.error
})
```

### 云函数使用示例：在云函数中调用另一个云函数

在云函数中，可以使用 swan-server-sdk 来访问当前环境中的其他资源，包括调用另一个云函数。在本例中，你会创建两个函数：sum 和 call_sum，然后在智能小程序端调用 call_sum 函数，call_sum 函数会调用 sum 函数获取结果，最终返回给智能小程序端。

需要注意的是，这里的调用是同步调用。也就是说，第二个函数的执行时间会全部计算到第一个函数的执行时间内。实际使用时，需要注意设置合理的函数超时时间。

我们先创建一个 sum 函数。

```js
	exports.main = (event, context) => {
	    if (Array.isArray(event['numbers'])) {
	        let sum = 0;
	        for (let i = 0; i < event['numbers'].length; i++) {
	            let n = parseInt(event['numbers'][i], 10);
	            sum += n;
	        }
	        return sum
	    } else {
	        throw new Error('no numbers');
	    }
	};
```

这个函数在 `event` 中接收一个 `numbers` 数组，并且将它们的和返回。

我们再创建一个 call_sum 函数。

```js
	const cloud = require('swan-server-sdk');
	
	exports.main = async (event, context) => {
	    cloud.init(context);
	
	    let resp = await cloud.callFunction({
	        name: 'sum',
	        data: {
	            numbers: [1, 2, 3, 4]
	        }
	    });
	 
	    console.log(resp);
	 
	    return 'sum: ' + resp.result
	};
```

要注意 package.json 中要有 swan-server-sdk 的依赖。

```json
	"dependencies": {
	  "swan-server-sdk": "latest"
	}
```

手动安装依赖：

	npm install

将这两个函数都部署到云开发后，可以在智能小程序中调用 call_sum 函数，正常的话可以看到返回结果。

	sum: 10

## 数据库开发常见问题

#### 如果设置记录的唯一ID？

在同一个集合中，创建的文档均有一个唯一 ID，存储在 `_id` 字段中。默认情况下，这个字段是一个 UUID，你也可以手动指定，保证唯一即可。

####  `_cbd_author_id` 字段代表什么含义？

当使用智能小程序端 SDK 创建记录（文档）时，云开发会将当前用户的 ID 存储在此字段中，表明该条记录的作者。参考用户集成相关问题。

## 云存储开发常见问题

####  文件名有什么限制？

* 不能为空；
* 不能以 `/` 开头和结尾；
* 不能出现连续的 `/`；
* 文件完整路径不能超过 1000 个字符。

## 用户集成相关问题

### 云开发的用户是什么概念？
在启用云开发的智能小程序中，每一个智能小程序的用户都会对应到云开发当前环境中的一个用户，无论该用户是否登陆了宿主应用。在智能小程序端新增数据库记录或者上传文件时，都会将操作者在云开发环境中的用户 ID 记录到相应的资源上，以表示该数据的创建者。当在智能小程序端修改这些数据时，云开发会检查相应的权限，允许或者拒绝修改操作。通过这种方式，可以直接在智能小程序端操作云端数据，而无需在云函数（服务端）进行用户身份的识别和访问权限的控制。

### 如何获取用户的 openid 或 swanid 信息？
在云函数中，可以从函数的 `context` 参数中获取到。已登陆的用户可以得到 openid，未登陆的用户可以得到 swanid。注意：如果是从云函数中调用另一个云函数，将不会包含用户信息。

### 如果用户在使用智能小程序时，先未登陆，后来登陆，对应到云开发中是几个用户 ID？
两个。今后会提供用户合并的功能。

### 在什么情况下会进行访问权限控制？
当使用智能小程序端 SDK 对云数据库和云存储进行操作的时候，会进行该项检查。在云开发控制台和云函数内的操作，不会进行检查和权限控制，可以任意读写。

### 目前的访问权限控制是怎样的？
已登录用户可写、可修改作者为自己的数据，未登录用户可写、不可修改，所有用户可读。

## 云开发配额

云开发采用套餐制计费，每一档套餐都规定了使用各种云上资源的限制。当前仅有基础版套餐供选择。

### 云数据库

|限额项目|基础版|
|---|---|
|总存储空间|2GB|
|读操作次数|30000次/天|
|写操作次数|30000次/天|
|集合总个数|100|
|单集合索引个数|10|
|同时连接数限制|30|

### 云存储

|限额项目|基础版|
|---|---|
|总存储空间|5GB|
|下载操作次数|50000次/天|
|上传操作次数|50000次/天|

### 云函数

|限额项目|基础版|
|---|---|
|函数总个数|20|
|调用次数|200000次/天|
|资源使用量|40000GB*s/月|
|外网下行流量|1GB/月|
|总并发数限制|100|
